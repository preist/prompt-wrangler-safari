(function(){"use strict";console.log("[Prompt Wrangler][content] loaded (isolated world)");function a(t){const s=Date.now(),o=Math.random().toString(36).substring(2,9),r=`batch-${s.toString()}-${o}`,n=t.map(e=>({...e,batchId:r}));return{batchId:r,issuesWithBatch:n}}(async()=>{try{const t=await chrome.storage.local.get(["settings.dataTypes","settings.protectedMode","allowlist"]);t["settings.dataTypes"]&&(window.dispatchEvent(new CustomEvent("prompt-wrangler-data-types-change",{detail:{dataTypes:t["settings.dataTypes"]}})),console.log("[Prompt Wrangler] Sent initial data types to injected script")),t["settings.protectedMode"]!==void 0&&(window.dispatchEvent(new CustomEvent("prompt-wrangler-mode-change",{detail:{enabled:t["settings.protectedMode"]}})),console.log("[Prompt Wrangler] Sent initial protected mode to injected script")),t.allowlist&&(window.dispatchEvent(new CustomEvent("prompt-wrangler-allowlist-change",{detail:{allowlist:t.allowlist}})),console.log("[Prompt Wrangler] Sent initial allowlist to injected script"))}catch(t){console.error("[Prompt Wrangler] Failed to load initial settings:",t)}})(),window.addEventListener("prompt-wrangler-issues",t=>{const s=t,{issues:o}=s.detail;console.log("[Prompt Wrangler][content] issues event received from injected:",o),(async()=>{const{batchId:r,issuesWithBatch:n}=a(o);try{const l=(await chrome.storage.local.get(["issues.history"]))["issues.history"]??[],i=[...n,...l];await chrome.storage.local.set({"issues.latestBatch":r,"issues.history":i}),console.log("[Prompt Wrangler][content] stored issues in storage",{batchId:r,count:n.length}),chrome.runtime.sendMessage({type:"NEW_ISSUES",issues:n}).catch(c=>{console.warn("[Prompt Wrangler][content] popup notify failed",c)})}catch(e){console.error("[Prompt Wrangler][content] failed to store issues locally",e)}chrome.runtime.sendMessage({type:"NEW_ISSUES",batchId:r,issues:n}).catch(e=>{console.warn("[Prompt Wrangler][content] direct NEW_ISSUES notify failed",e)});try{const e={type:"ISSUES_DETECTED",issues:n};await chrome.runtime.sendMessage(e),console.log("[Prompt Wrangler][content] sent issues to background")}catch(e){console.error("[Prompt Wrangler][content] Error sending issues to background:",e)}})()}),chrome.runtime.onMessage.addListener((t,s,o)=>{t.type==="TOGGLE_PROTECTED_MODE"&&(console.log("[Prompt Wrangler] Protected mode toggled:",t.enabled),console.log("[Prompt Wrangler][content] forwarded protected mode toggle to injected"),window.dispatchEvent(new CustomEvent("prompt-wrangler-mode-change",{detail:{enabled:t.enabled}}))),t.type==="UPDATE_DATA_TYPES"&&(console.log("[Prompt Wrangler] Data types updated:",t.dataTypes),console.log("[Prompt Wrangler][content] forwarded data types update to injected"),window.dispatchEvent(new CustomEvent("prompt-wrangler-data-types-change",{detail:{dataTypes:t.dataTypes}})))}),chrome.storage.onChanged.addListener((t,s)=>{if(s==="local"&&t.allowlist){const o=t.allowlist.newValue;window.dispatchEvent(new CustomEvent("prompt-wrangler-allowlist-change",{detail:{allowlist:o??[]}})),console.log("[Prompt Wrangler][content] Allowlist changed, notified injected script")}})})();
