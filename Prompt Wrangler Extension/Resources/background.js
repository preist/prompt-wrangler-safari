(function(){"use strict";console.log("[Prompt Wrangler][background] loaded");async function r(){try{const t=(await chrome.storage.local.get(["settings.protectedMode"]))["settings.protectedMode"],e={16:t===!1?"icons/icon-16-off.png":"icons/icon-16.png",32:t===!1?"icons/icon-32-off.png":"icons/icon-32.png"};await chrome.action.setIcon({path:e}),console.log("[Prompt Wrangler] Icon updated:",e)}catch(o){console.error("[Prompt Wrangler] Failed to update icon:",o)}}chrome.storage.onChanged.addListener((o,t)=>{t==="local"&&o["settings.protectedMode"]&&r()}),r(),chrome.runtime.onMessage.addListener((o,t,e)=>(console.log("[Prompt Wrangler][background] onMessage",o.type,o,t),o.type==="ISSUES_DETECTED"&&(console.log("[Prompt Wrangler] Background received issues:",o.issues),(async()=>{try{const s=Date.now(),c=Math.random().toString(36).substring(2,9),n=`batch-${s.toString()}-${c}`,a=o.issues.map(g=>({...g,batchId:n})),i=(await chrome.storage.local.get(["issues.history"]))["issues.history"]??[],l=[...a,...i];await chrome.storage.local.set({"issues.latestBatch":n,"issues.history":l}),console.log("[Prompt Wrangler] Stored issues in chrome.storage");const d=o.issues.length;await chrome.action.setBadgeText({text:d.toString()}),await chrome.action.setBadgeBackgroundColor({color:"#DC2626"}),chrome.runtime.sendMessage({type:"NEW_ISSUES",issues:o.issues},()=>{chrome.runtime.lastError&&console.log("[Prompt Wrangler] Popup not open, issues stored for later")})}catch(s){console.error("[Prompt Wrangler] Failed to store issues:",s)}})()),!1))})();
