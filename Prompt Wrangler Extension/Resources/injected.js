(function(){"use strict";const m=/\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/g,y=/(?:\+?1\s?[-.]?\s?)?\(?[2-9]\d{2}\)?\s?[-.]?\s?\d{3}\s?[-.]?\s?\d{4}\b/g,P=/\+\d{1,3}\s?[-.]?\s?(?:\(?\d{1,4}\)?[\s.-]?)?\d{1,4}[\s.-]?\d{1,4}[\s.-]?\d{1,4}(?:[\s.-]?\d{1,4})?\b/g,g=/\b(?:\d{4}[\s-]?){3}\d{4}\b/g,h=/\b\d{3}[-\s]?\d{2}[-\s]?\d{4}\b/g,C="[EMAIL_ADDRESS]",b="[PHONE_NUMBER]",D="[CREDIT_CARD]",T="[SSN]",E=[P,y];console.log("[Prompt Wrangler] Injected script (main world) loaded");const u=window.fetch;let f=!0,a={email:!0,phone:!0,creditCard:!0,ssn:!0},p=[];window.addEventListener("prompt-wrangler-mode-change",t=>{f=t.detail.enabled,console.log("[Prompt Wrangler] Protected mode changed:",f)}),window.addEventListener("prompt-wrangler-data-types-change",t=>{a=t.detail.dataTypes,console.log("[Prompt Wrangler] Data types changed:",a)}),window.addEventListener("prompt-wrangler-allowlist-change",t=>{p=t.detail.allowlist,console.log("[Prompt Wrangler] Allowlist changed:",p)});function l(){return`${Date.now().toString()}-${Math.random().toString(36).substring(2,9)}`}function c(t,e){const r=Date.now(),n=t.toLowerCase();return p.some(o=>o.type!==e||o.value.toLowerCase()!==n?!1:o.expiresAt==="never"?!0:o.expiresAt>r)}function N(t){if(!a.email)return[];const e=t.matchAll(m),r=[];for(const n of e)n[0]&&!c(n[0],"email")&&r.push({id:l(),type:"email",value:n[0],timestamp:Date.now()});return r}function S(t){if(!a.phone)return[];const e=[],r=new Set;for(const n of E)for(const o of t.matchAll(n))o[0]&&!r.has(o[0])&&!c(o[0],"phone")&&(r.add(o[0]),e.push({id:l(),type:"phone",value:o[0],timestamp:Date.now()}));return e}function R(t){return a.email?t.replace(m,e=>c(e,"email")?e:C):t}function L(t){if(!a.phone)return t;let e=t;for(const r of E)e=e.replace(r,n=>c(n,"phone")?n:b);return e}function _(t){if(!a.creditCard)return[];const e=t.matchAll(g),r=[];for(const n of e)n[0]&&!c(n[0],"creditCard")&&r.push({id:l(),type:"creditCard",value:n[0],timestamp:Date.now()});return r}function I(t){return a.creditCard?t.replace(g,e=>c(e,"creditCard")?e:D):t}function O(t){if(!a.ssn)return[];const e=t.matchAll(h),r=[];for(const n of e)n[0]&&!c(n[0],"ssn")&&r.push({id:l(),type:"ssn",value:n[0],timestamp:Date.now()});return r}function v(t){return a.ssn?t.replace(h,e=>c(e,"ssn")?e:T):t}function z(t){const e=[];function r(o){if(typeof o=="string"){let s=o;const i=N(s);i.length>0&&(e.push(...i),s=R(s));const d=_(s);d.length>0&&(e.push(...d),s=I(s));const w=O(s);w.length>0&&(e.push(...w),s=v(s));const A=S(s);return A.length>0&&(e.push(...A),s=L(s)),s}if(Array.isArray(o))return o.map(s=>r(s));if(o!==null&&typeof o=="object"){const s={};for(const[i,d]of Object.entries(o))s[i]=r(d);return s}return o}return{anonymized:r(t),issues:e}}window.fetch=async function(t,e){const r=typeof t=="string"?t:t instanceof URL?t.href:t.url;if(console.log("[Prompt Wrangler] Fetch intercepted:",r),!f)return console.log("[Prompt Wrangler] Protected mode disabled, skipping scan"),await u(t,e);if(r.includes("/backend-api/")&&e?.method==="POST"&&e.body&&typeof e.body=="string"){console.log("[Prompt Wrangler] ChatGPT API request detected, scanning...");try{const n=JSON.parse(e.body),{anonymized:o,issues:s}=z(n);if(s.length>0){console.log("[Prompt Wrangler] Detected issues:",s),window.dispatchEvent(new CustomEvent("prompt-wrangler-issues",{detail:{issues:s}}));const i={...e,body:JSON.stringify(o)};return await u(t,i)}}catch(n){console.error("[Prompt Wrangler] Error scanning request:",n)}}return await u(t,e)},console.log("[Prompt Wrangler] Fetch override installed")})();
