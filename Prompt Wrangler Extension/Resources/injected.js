(function(){"use strict";const h=/\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/g,A=/(?:\+?1\s?[-.]?\s?)?\(?[2-9]\d{2}\)?\s?[-.]?\s?\d{3}\s?[-.]?\s?\d{4}\b/g,b=/\+\d{1,3}\s?[-.]?\s?(?:\(?\d{1,4}\)?[\s.-]?)?\d{1,4}[\s.-]?\d{1,4}[\s.-]?\d{1,4}(?:[\s.-]?\d{1,4})?\b/g,y=/\b(?:\d{4}[\s-]?){3}\d{4}\b/g,E=/\b\d{3}[-\s]?\d{2}[-\s]?\d{4}\b/g,T="[EMAIL_ADDRESS]",S="[PHONE_NUMBER]",v="[CREDIT_CARD]",D="[SSN]",w=[b,A];console.log("[Prompt Wrangler][injected] loaded in main world");const u=window.fetch;let m=!0,i={email:!0,phone:!0,creditCard:!0,ssn:!0},f=[],c=null;window.addEventListener("prompt-wrangler-mode-change",t=>{m=t.detail.enabled,console.log("[Prompt Wrangler][injected] Protected mode changed:",m)}),window.addEventListener("prompt-wrangler-data-types-change",t=>{i=t.detail.dataTypes,console.log("[Prompt Wrangler][injected] Data types changed:",i)}),window.addEventListener("prompt-wrangler-allowlist-change",t=>{f=t.detail.allowlist,console.log("[Prompt Wrangler][injected] Allowlist changed:",f)});function d(){return`${Date.now().toString()}-${Math.random().toString(36).substring(2,9)}`}function l(t,e){const o=Date.now(),n=t.toLowerCase();return f.some(s=>s.type!==e||s.value.toLowerCase()!==n?!1:s.expiresAt==="never"?!0:s.expiresAt>o)}function x(t){if(!i.email)return[];const e=t.matchAll(h),o=[];for(const n of e)n[0]&&!l(n[0],"email")&&o.push({id:d(),type:"email",value:n[0],timestamp:Date.now()});return o}function N(t){if(!i.phone)return[];const e=[],o=new Set;for(const n of w)for(const s of t.matchAll(n))s[0]&&!o.has(s[0])&&!l(s[0],"phone")&&(o.add(s[0]),e.push({id:d(),type:"phone",value:s[0],timestamp:Date.now()}));return e}function R(t){return i.email?t.replace(h,e=>l(e,"email")?e:T):t}function L(t){if(!i.phone)return t;let e=t;for(const o of w)e=e.replace(o,n=>l(n,"phone")?n:S);return e}function _(t){if(!i.creditCard)return[];const e=t.matchAll(y),o=[];for(const n of e)n[0]&&!l(n[0],"creditCard")&&o.push({id:d(),type:"creditCard",value:n[0],timestamp:Date.now()});return o}function z(t){return i.creditCard?t.replace(y,e=>l(e,"creditCard")?e:v):t}function I(t){if(!i.ssn)return[];const e=t.matchAll(E),o=[];for(const n of e)n[0]&&!l(n[0],"ssn")&&o.push({id:d(),type:"ssn",value:n[0],timestamp:Date.now()});return o}function W(t){return i.ssn?t.replace(E,e=>l(e,"ssn")?e:D):t}function O(t){const e=[];function o(s){if(typeof s=="string"){let r=s;const a=x(r);a.length>0&&(e.push(...a),r=R(r));const p=_(r);p.length>0&&(e.push(...p),r=z(r));const P=I(r);P.length>0&&(e.push(...P),r=W(r));const C=N(r);return C.length>0&&(e.push(...C),r=L(r)),r}if(Array.isArray(s))return s.map(r=>o(r));if(s!==null&&typeof s=="object"){const r={};for(const[a,p]of Object.entries(s))r[a]=o(p);return r}return s}return{anonymized:o(t),issues:e}}function g(){c?.parentElement?.removeChild(c),c=null}function H(t){g();const e=document.createElement("div");e.style.position="fixed",e.style.right="16px",e.style.top="16px",e.style.zIndex="2147483000",e.style.background="var(--pw-toast-bg, #ffffff)",e.style.color="var(--pw-toast-fg, #111827)",e.style.padding="12px 14px",e.style.borderRadius="10px",e.style.boxShadow="0 14px 35px rgba(0, 0, 0, 0.18)",e.style.maxWidth="320px",e.style.fontFamily='system-ui, -apple-system, "Segoe UI", sans-serif',e.style.fontSize="14px",e.style.lineHeight="1.4",e.style.display="grid",e.style.gridTemplateColumns="1fr auto",e.style.gap="8px";const o=document.createElement("div");o.textContent=t.length===1?"Prompt Wrangler sanitized 1 item":`Prompt Wrangler sanitized ${String(t.length)} items`,o.style.fontWeight="600";const n=document.createElement("div"),s=t[0]?.value??"",r=typeof s=="string"&&s.length>40?`${s.slice(0,40)}…`:s;n.textContent=`Open the Prompt Wrangler popup for details.${s?` Example: ${r}`:""}`,n.style.opacity="0.9";const a=document.createElement("button");a.textContent="×",a.setAttribute("aria-label","Close"),a.style.background="transparent",a.style.border="none",a.style.color="inherit",a.style.cursor="pointer",a.style.fontSize="16px",a.style.lineHeight="1",a.style.padding="0 0 4px 8px",a.addEventListener("click",g),e.appendChild(o),e.appendChild(a),e.appendChild(n),document.body.appendChild(e),c=e,window.setTimeout(g,6e3)}window.fetch=async function(t,e){const o=typeof t=="string"?t:t instanceof URL?t.href:t.url;if(console.log("[Prompt Wrangler] Fetch intercepted:",o),!m)return console.log("[Prompt Wrangler] Protected mode disabled, skipping scan"),await u(t,e);if(o.includes("/backend-api/")&&e?.method==="POST"&&e.body&&typeof e.body=="string"){console.log("[Prompt Wrangler] ChatGPT API request detected, scanning...");try{const n=JSON.parse(e.body),{anonymized:s,issues:r}=O(n);if(r.length>0){console.log("[Prompt Wrangler][injected] Detected issues:",r),window.dispatchEvent(new CustomEvent("prompt-wrangler-issues",{detail:{issues:r}})),H(r);const a={...e,body:JSON.stringify(s)};return console.log("[Prompt Wrangler][injected] sending issues event to content script"),await u(t,a)}}catch(n){console.error("[Prompt Wrangler] Error scanning request:",n)}}return await u(t,e)},console.log("[Prompt Wrangler][injected] Fetch override installed")})();
